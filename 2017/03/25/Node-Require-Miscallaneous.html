<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Node Require Miscallaneous ...</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://mimiz.github.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic|Open+Sans:400italic,700italic,700,400">
    <link rel="stylesheet" type="text/css" href="//mimiz.github.io/themes/roon/assets/css/screen.css?v=1491769645895" />

    <link rel="canonical" href="https://mimiz.github.io/2017/03/25/Node-Require-Miscallaneous.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Rémi&#x27;s Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Node Require Miscallaneous ..." />
    <meta property="og:description" content="So times ago (I don&amp;#8217;t really remember when), working on a Node.Js project, I realised something about require. The situation &amp;#8230;&amp;#8203; Imagine we have some datas in a Json file we want to access in different modules. datas.json {   &quot;version&quot;:&quot;0.1&quot;,   &quot;name&quot;:&quot;MyApplication&quot; } This datas." />
    <meta property="og:url" content="https://mimiz.github.io/2017/03/25/Node-Require-Miscallaneous.html" />
    <meta property="article:published_time" content="2017-03-25T00:00:00.000Z" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Node Require Miscallaneous ..." />
    <meta name="twitter:description" content="So times ago (I don&amp;#8217;t really remember when), working on a Node.Js project, I realised something about require. The situation &amp;#8230;&amp;#8203; Imagine we have some datas in a Json file we want to access in different modules. datas.json {   &quot;version&quot;:&quot;0.1&quot;,   &quot;name&quot;:&quot;MyApplication&quot; } This datas." />
    <meta name="twitter:url" content="https://mimiz.github.io/2017/03/25/Node-Require-Miscallaneous.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Rémi's Blog",
    "author": {
        "@type": "Person",
        "name": "mimiz33",
        "image": "https://avatars1.githubusercontent.com/u/377238?v=3",
        "url": "https://mimiz.github.io/author/mimiz/",
        "sameAs": "http://www.mimiz.fr"
    },
    "headline": "Node Require Miscallaneous ...",
    "url": "https://mimiz.github.io/2017/03/25/Node-Require-Miscallaneous.html",
    "datePublished": "2017-03-25T00:00:00.000Z",
    "description": "So times ago (I don&amp;#8217;t really remember when), working on a Node.Js project, I realised something about require. The situation &amp;#8230;&amp;#8203; Imagine we have some datas in a Json file we want to access in different modules. datas.json {   &quot;version&quot;:&quot;0.1&quot;,   &quot;name&quot;:&quot;MyApplication&quot; } This datas."
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Rémi&#x27;s Blog" href="https://mimiz.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
</head>
<body class="post-template  noimage">

    


    <article role="main" class="">
        <header>
            <a href="https://mimiz.github.io" id="home_link">«</a>
            <div class="meta"><time datetime="2017-03-25"><a href="https://mimiz.github.io/2017/03/25/Node-Require-Miscallaneous.html">March 25, 2017</a></time> <span class="count" id="js-reading-time"></span></div>
            <h1>Node Require Miscallaneous ...</h1>
        </header>

        <div class="text" id="js-post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>So times ago (I don&#8217;t really remember when), working on a Node.Js project, I realised something about <code>require</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_situation">The situation &#8230;&#8203;</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imagine we have some datas in a Json file we want to access in different modules.</p>
</div>
<div class="listingblock">
<div class="title">datas.json</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "version":"0.1",
  "name":"MyApplication"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>datas.json</code> is quite short, but for explaining the situation it is more than enough !</p>
</div>
<div class="paragraph">
<p>Now the code :</p>
</div>
<div class="listingblock">
<div class="title">index.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var module1 = require('./module1.js'),
    module2 = require('./module2.js');

module1.log();
module2.log();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">module1.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var myDatas = require('./datas.json');

module.exports = {
  log:function(){
    console.log(myDatas);
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">module2.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var myDatas = require('./datas.json');

module.exports = {
  log:function(){
    console.log(myDatas);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, <code>module1</code> and <code>module2</code> are exactly same.</p>
</div>
<div class="paragraph">
<p>So if we execute the code, we will have the following output :</p>
</div>
<div class="listingblock">
<div class="title">output 1</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'MyApplication' }
{ version: 'O.1', name: 'MyApplication' }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, now imagine <code>module1</code> will modify some value before logging :</p>
</div>
<div class="listingblock">
<div class="title">module1.js (version 2)</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var myDatas = require('./datas.json');

module.exports = {
  log:function(){
    lowerCaseName() <i class="conum" data-value="1"></i><b>(1)</b>
    console.log(myDatas);
  }
}

function lowerCaseName(){
  myDatas.name = myDatas.name.toLowerCase();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We just add this simple function that will lowerCase the name.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In my idea, this should not affect the <code>module2</code> as they should be independant, so when I execute the code, here is the output :</p>
</div>
<div class="listingblock">
<div class="title">output 2</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'myapplication' }
{ version: 'O.1', name: 'myapplication' }<i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Damned !</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/mimiz/node_require_cache">Source code</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why">Why</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Actually the reason is quite simple, when you require the file <code>datas.json</code>, require will create the object and store it in the <code>require.cache</code> object, then next time you use <code>require('./datas.json')</code> to retreive the datas, require will return you the value in that <code>require.cache</code> object.</p>
</div>
<div class="paragraph">
<p>So it mean that it gives you the reference to the value, so if you change one property of that value, all other modules are affected as you are actually doing the change on the reference in the cache.</p>
</div>
<div class="quoteblock">
<div class="title">This is quite well documented in the Node.js documentation :</div>
<blockquote>
<div class="paragraph">
<p>Modules are cached after the first time they are loaded. This means (among other things) that every call to require('foo') will get exactly the same object returned, if it would resolve to the same file.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Node.Js Documentation<br>
<cite>https://nodejs.org/api/modules.html#modules_caching</cite>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Remember that Node.Js is single thread, it mean for example that the require cache is shared accross all requests</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_have_the_desired_behaviour">How to have the desired behaviour</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now I will try to make the code work as desired.</p>
</div>
<div class="paragraph">
<p>Some of the solutions are not solving the problem, but I wanted to try to see how it works &#8230;&#8203;</p>
</div>
<div class="sect2">
<h3 id="_the_em_const_em_way_fail">The <em>Const</em> way &#8230;&#8203; FAIL</h3>
<div class="paragraph">
<p>First I wanted to use the new ES6 <code>const</code> instead of <code>var</code> in the line</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">// replace
var myDatas = require('./datas.json');
// with
const myDatas = require('./datas.json');</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">output 3</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'myapplication' }
{ version: 'O.1', name: 'myapplication' }<i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Damned !</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But actually, <code>const</code> do not prevent the variable to be modified, but prevent reafectation.</p>
</div>
<div class="paragraph">
<p><span class="red big">FAIL</span>
<a href="https://github.com/mimiz/node_require_cache/tree/const_way">Source Code, branch const_way</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_the_em_delete_em_way_success">The <em>delete</em> way &#8230;&#8203; SUCCESS</h3>
<div class="paragraph">
<p>With this solution, you will <code>delete</code> the reference in the <code>require.cache</code> object before require the <code>datas.json</code> file like this :</p>
</div>
<div class="listingblock">
<div class="title">module2.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">delete require.cache[require.resolve('./datas.json')];
var myDatas = require('./datas.json');
// Code continue ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may not know how your modules are inserted, you need to add the line on every files that need to use the <code>datas.json</code> file.</p>
</div>
<div class="paragraph">
<p>In my opinion, this is not very convenient, but it works :</p>
</div>
<div class="listingblock">
<div class="title">output 4</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'myapplication' }
{ version: 'O.1', name: 'MyApplication' } <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Great !</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I Think that this solution is the <strong><em>"Quick And Dirty"</em></strong> solution.</p>
</div>
<div class="paragraph">
<p><strong class="green big">SUCCESS</strong></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/mimiz/node_require_cache/tree/delete_way">Source Code, branch delete_way</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_the_em_proxy_em_way_success">The <em>Proxy</em> Way &#8230;&#8203; SUCCESS</h3>
<div class="paragraph">
<p>With this solution I imagine to create a <code>Proxy</code> around the json datas, and override the <code>set</code> method, in order to forbid the manipulation of the value.</p>
</div>
<div class="paragraph">
<p>This approach can be usefull to throw excpetion if someone try to set the property value.</p>
</div>
<div class="paragraph">
<p>Here is the code :</p>
</div>
<div class="listingblock">
<div class="title">datasProxy.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var datas = require('./datas.json'); <i class="conum" data-value="1"></i><b>(1)</b>

module.exports = new Proxy(datas, {
  set:function(){
    return; <i class="conum" data-value="2"></i><b>(2)</b>
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This should be the only location in the app where you require the json file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here, we just do nothing, but we could throw exception here to reject any modification of any properties.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also need to change the reference in <code>module1</code> and <code>module2</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">// Replace
var myDatas = require('./datas.json');
// with
var myDatas = require('./datasProxy');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Can you see a big problem ?</p>
</div>
<div class="paragraph">
<p>YES, the code in <code>module1</code> should be updated because now we can not set the property (even locally)</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first execute the code without any modification :</p>
</div>
<div class="listingblock">
<div class="title">output 5</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'MyApplication' }
{ version: 'O.1', name: 'MyApplication' }</code></pre>
</div>
</div>
<div class="paragraph">
<p>So there is a problem, the first line should display the text MyApplciation in lowercase.
So let&#8217;s edit the code in <code>module1</code> to have the desired behaviour.</p>
</div>
<div class="paragraph">
<p>Here is a working code :</p>
</div>
<div class="listingblock">
<div class="title">module1.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var myDatas = Object.assign({}, require('./datasProxy')); <i class="conum" data-value="1"></i><b>(1)</b>

module.exports = {
  log:function(){
    lowerCaseName()
    console.log(myDatas);
  }
}

function lowerCaseName(){
  myDatas.name = myDatas.name.toLowerCase();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use <code>Object.assign()</code> to create a <em>"copy"</em> of the object in the <code>module1</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we look at the output :</p>
</div>
<div class="listingblock">
<div class="title">output 6</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'myapplication' }
{ version: 'O.1', name: 'MyApplication' }</code></pre>
</div>
</div>
<div class="paragraph">
<p>So it works !</p>
</div>
<div class="paragraph">
<p>But, as the MDN web site says:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>"The <code>Object.assign()</code> method only copies enumerable and own properties from a source object to a target object."</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Mozilla Developper Network<br>
<cite>http://devdocs.io/javascript/global_objects/object/assign</cite>
</div>
</div>
<div class="paragraph">
<p>Maybe you should use a "clone" function that allow to clone objects deeply (check this with lodash <a href="https://lodash.com/docs/4.17.4#clone"><code>_.clone()</code></a> for example)</p>
</div>
<div class="paragraph">
<p>I think this solution is not too bad, but the thing is that you delegate to the module the need to create a copy, maybe this suits your needs, or maybe we can do it in the proxy itself.</p>
</div>
<div class="paragraph">
<p>I think both solution can be justified, you just need to make a choice.</p>
</div>
<div class="paragraph">
<p><strong class="green big">SUCCESS</strong></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/mimiz/node_require_cache/tree/proxy_way">Source Code, branch proxy_way</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_the_em_clone_em_way_success">The <em>Clone</em> Way  &#8230;&#8203; SUCCESS</h3>
<div class="paragraph">
<p>This solution is the solution I considered previously.</p>
</div>
<div class="paragraph">
<p>So with this solution, the <em>"Proxy"</em> (or you can call it, the <em>"wrapper"</em>) will create the copy and returns it to the modules :</p>
</div>
<div class="paragraph">
<p>So edit the Proxy code, and the modules :</p>
</div>
<div class="listingblock">
<div class="title">datasProxy.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var datas = require('./datas.json');

module.exports = function(){ <i class="conum" data-value="1"></i><b>(1)</b>
  return clone(datas);
}

function clone(datas){
  return JSON.parse(JSON.stringify(datas)); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We export a function that need to be called in module to return a copy of the datas</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we use a hack to clone <em>"deeply"</em> an object.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then edit the modules to call the exported function</p>
</div>
<div class="listingblock">
<div class="title">module1.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var myDatas = require('./datasProxy')(); <i class="conum" data-value="1"></i><b>(1)</b>

module.exports = {
  log:function(){
    lowerCaseName()
    console.log(myDatas);
  }
}

function lowerCaseName(){
  myDatas.name = myDatas.name.toLowerCase();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call the function to get the copy.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">module2.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var myDatas = require('./datasProxy')(); <i class="conum" data-value="1"></i><b>(1)</b>

module.exports = {
  log:function(){
    console.log(myDatas);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call the function to get the copy.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then execute the code :</p>
</div>
<div class="listingblock">
<div class="title">output 7</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'myapplication' }
{ version: 'O.1', name: 'MyApplication' }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Great it works !</p>
</div>
<div class="paragraph">
<p>This is my favorite solution.</p>
</div>
<div class="paragraph">
<p><strong class="green big">SUCCESS</strong></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/mimiz/node_require_cache/tree/clone_way">Source Code, branch clone_way</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_the_em_decache_em_way_success">The <em>decache</em> way &#8230;&#8203; SUCCESS</h3>
<div class="paragraph">
<p>This idea was given to me by <a href="https://jermor.in/">Jérémy  Morin</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/decache">Decache</a> is a Node Module, that remove module from the <code>require</code> cache.</p>
</div>
<div class="paragraph">
<p>This solution has exactly the same effect than the <em>delete</em> solution I present before. But it make it easier to do.</p>
</div>
<div class="paragraph">
<p>First you need to install the <code>decache</code> node module :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">npm init <i class="conum" data-value="1"></i><b>(1)</b>
npm install decache --save</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is not necessary if you already initialise a node project.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then edit the code :</p>
</div>
<div class="listingblock">
<div class="title">index.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var module1 = require('./module1.js'),
    module2 = require('./module2.js');

module1.log();
module2.log();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">module1.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var myDatas = require('./datas.json');

module.exports = {
  log:function(){
    lowerCaseName()
    console.log(myDatas);
  }
}

function lowerCaseName(){
  myDatas.name = myDatas.name.toLowerCase();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">module2.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var decache = require('decache'); <i class="conum" data-value="1"></i><b>(1)</b>
decache('./datas.json'); <i class="conum" data-value="2"></i><b>(2)</b>
var myDatas = require('./datas.json');

module.exports = {
    log: function() {
        console.log(myDatas);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First we need to require the <em>decache</em> module</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we use <em>decache</em> to remove the datas.json file from the cache</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Maybe we should use <em>decache</em> from both <code>module1.js</code> and <code>module2.js</code> because if we invert the the two <em>require</em> lines in the <code>index.js</code> file the cache is not removed as we expect.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">output 7</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'myapplication' }
{ version: 'O.1', name: 'MyApplication' }</code></pre>
</div>
</div>
<div class="paragraph">
<p>It works !</p>
</div>
<div class="paragraph">
<p><strong class="green big">SUCCESS</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_the_em_import_em_way_aka_the_em_es6_em_way_fail">The <em>import</em> Way (aka. the <em>ES6</em> way) &#8230;&#8203; FAIL</h3>
<div class="paragraph">
<p>This idea was also given to me by <a href="https://jermor.in/">Jérémy  Morin</a>.</p>
</div>
<div class="paragraph">
<p>As Node.JS (version 7.4.0 on my laptop) is not compatible with the ES6 (import) syntax, we will need to <em>"babelize"</em> (transpile with babel) the code, and for that we need to refactor our code, and initilaze a npm project.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First create a <code>src</code> doirectory and copy all files inside that directory</p>
</li>
<li>
<p>In a terminal window run the <code>npm init</code> command and answer all question</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">npm init</code></pre>
</div>
</div>
</li>
<li>
<p>Then install the <code>babel-cli</code> dependency</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">npm install babel-cli --save-dev</code></pre>
</div>
</div>
</li>
<li>
<p>Create a <em>"build"</em> script</p>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "name": "require_strange",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "build": "babel src -d lib" <i class="conum" data-value="1"></i><b>(1)</b>
  },
  "author": "",
  "license": "ISC",
  "dependencies": {},
  "devDependencies": {
    "babel-cli": "^6.24.1"
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Now you can use <code>npm run build</code> to build from ES6 code</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure babel :</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Install the <em>presets</em></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">npm install babel-preset-env --save-dev</code></pre>
</div>
</div>
</li>
<li>
<p>Create the <code>.babelrc</code></p>
<div class="listingblock">
<div class="title">/.babelrc</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "presets":["env"]
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Edit the Code to convert it to ES6</p>
<div class="listingblock">
<div class="title">/src/datas.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">export default {
  "version": "0.1",
  "name": "MyApplication"
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/src/index.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import module1 from './module1';
import module2 from './module2';

module1.log();
module2.log();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/src/module1.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import myDatas from './datas';

export default {
    log: function() {
        lowerCaseName();
        console.log(myDatas);
    }
};

function lowerCaseName() {
    myDatas.name = myDatas.name.toLowerCase();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/src/module2.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import myDatas from './datas';


export default {
    log: function() {
        console.log(myDatas);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Build</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">npm run build</code></pre>
</div>
</div>
</li>
<li>
<p>Run</p>
<div class="listingblock">
<div class="title">output 9</div>
<div class="content">
<pre class="highlight"><code class="language-zsh" data-lang="zsh">⇒  node index.js
{ version: 'O.1', name: 'myapplication' }
{ version: 'O.1', name: 'myapplication' }</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you can see the execution output exactly the same, so this is not a good solution.</p>
</div>
<div class="paragraph">
<p><strong class="red big">FAIL</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a conclusion, I would say that it is important to understand how the <code>require</code> cache works, that&#8217;s why I wrote this article.</p>
</div>
<div class="paragraph">
<p>In order to solve the problem presented in the introduction, I would use the <em>"clone"</em> solution, by creating a <em>"wrapper"</em> object, maybe using the <code>Proxy</code> from ES6.</p>
</div>
<div class="paragraph">
<p>Please feel free to make any comments &#8230;&#8203;</p>
</div>
</div>
</div>
        </div>

        <menu>
            <a href="" id="btn_share" class="btn" title="Share">
                <span aria-hidden="true" data-icon="S"></span>
                <strong>Share</strong>
            </a>
            <a href="http://twitter.com/share?text=Node%20Require%20Miscallaneous%20...&url=https://mimiz.github.io/2017/03/25/Node-Require-Miscallaneous.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" id="btn_comment" class="btn" target="_blank">
                <span aria-hidden="true" data-icon="C"></span> Comment on Twitter
            </a>
        </menu>


        <footer class="post-footer" role="contentinfo">

            <div class="vcard">
                <a href="https://mimiz.github.io/rss" id="btn_feed" class="btn" title="Feed" target="_blank">
                    <span aria-hidden="true" data-icon=")"></span>
                    <strong>Feed</strong>
                </a>

                <a href="https://mimiz.github.io/author/mimiz/" class="photo">
                    <span style="background-image: url('https://avatars1.githubusercontent.com/u/377238?v&#x3D;3');">
                        <img src="https://avatars1.githubusercontent.com/u/377238?v&#x3D;3" alt="mimiz33">
                    </span>
                </a>

                <div class="details">
                    <h4><a href="https://mimiz.github.io/author/mimiz/" class="url n">mimiz33</a></h4>
                    
                    <a href="http://www.mimiz.fr" class="js-remove-domain-schema">http://www.mimiz.fr</a>
                </div>
            </div>

            <div id="user_bio">
                <div class="inner">
                    
                </div>
            </div>

        </footer>




    </article>

    <div id="share_modal">
        <div class="wrap">
            <div class="inner">
                <header>
                    Share
                    <a href="" class="close" title="Close">&times;</a>
                </header>

                <div class="roon-share-links">
                    <a href="https://twitter.com/share" class="twitter-share-button" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    <div id="fb-elems">
                        <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                        var js, fjs = d.getElementsByTagName(s)[0];
                        if (d.getElementById(id)) return;
                        js = d.createElement(s); js.id = id;
                        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=463438580397968";
                        fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));</script>
                        <div class="fb-like" data-send="false" data-layout="button_count" data-width="110" data-show-faces="false" data-font="arial"></div>
                    </div>

                    <div id="pinit-btn">
                        <a href="//pinterest.com/pin/create/button/?url=https://mimiz.github.io/2017/03/25/Node-Require-Miscallaneous.html&amp;description=Node%20Require%20Miscallaneous%20...-R%C3%A9mi's%20Blog " data-pin-do="buttonPin" data-pin-config="beside"><img src="//assets.pinterest.com/images/pidgets/pin_it_button.png"></a>
                        <script type="text/javascript" src="//assets.pinterest.com/js/pinit.js"></script>
                    </div>
                </div>
            </div>
        </div>
    </div>






    <script>

            function get_text(el) {
                ret = "";
                var length = el.childNodes.length;
                for(var i = 0; i < length; i++) {
                    var node = el.childNodes[i];
                    if(node.nodeType != 8) {
                        ret += node.nodeType != 1 ? node.nodeValue : get_text(node);
                    }
                }
                return ret;
            }
            function reading_time () {
                var post_content = document.getElementById('js-post-content');
                if (post_content) {
                    var words = get_text(post_content),
                        count = words.split(/\s+/).length,
                        read_time = Math.ceil((count / 150)),
                        read_time_node = document.createTextNode(read_time + ' min read');
                    document.getElementById('js-reading-time').appendChild(read_time_node);
                }
            }

        function no_schema_links () {
            var links = document.querySelectorAll('.js-remove-domain-schema');
            if (links) {
                for (i = 0; i < links.length; ++i) {
                    var link = links[i],
                        text = link.innerHTML,
                        no_schema = text.replace(/.*?:\/\//g, "");
                    link.innerHTML = no_schema;
                }
            }
        }

        window.onload = function () {
            no_schema_links();

            reading_time();
        }
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>
       
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

        <script>
            $(function(){
                var share_modal = $("#share_modal"),
                    update_social_links = true;

                $("#btn_share").click(function(){
                    var that = $(this);
                    share_modal.fadeIn(200);
                    return false;
                });

                share_modal.click(function(e){
                    if (e.target.className == "wrap" || e.target.id == "share_modal") {
                        share_modal.fadeOut(200);
                    }
                    return false;
                });

                share_modal.find("div.inner > header > a.close").click(function(){
                    share_modal.fadeOut(200);
                    return false;
                });
            });
        </script>


    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-18243278-5', 'auto');
    ga('send', 'pageview');

    </script>

</body>
</html>
